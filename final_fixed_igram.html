<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π ABA –ß–µ–∫-–ª–∏—Å—Ç</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:16px; max-width:960px; margin:auto; background:#f8f9fa; }
    h2,h3 { text-align:center; margin-bottom:16px; }
    .controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    body.editing .btn-set button { pointer-events:none; opacity:0.5; }
    .protocol-container { background:#fff; border-radius:12px; padding:16px; margin-bottom:24px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .block { margin-bottom:16px; }
    .goal-label { display:block; padding:8px; background:#e9ecef; border-radius:4px; margin-bottom:8px; }
    .btn-set { display:flex; justify-content:space-around; gap:12px; margin-bottom:8px; }
    .btn-set button { flex:1; padding:18px; font-size:26px; border:none; border-radius:12px; }
    .btn-success { background:#d4edda; }
    .btn-prompt  { background:#fff3cd; }
    .btn-error   { background:#f8d7da; }
    .count { text-align:center; font-weight:bold; font-size:16px; margin-top:6px; }
    .percent { text-align:right; font-weight:bold; }
    .prev-percent { font-size:12px; color:#555; margin-top:4px; }
    .prev-percent::before { content:'–ü—Ä–µ–¥. —Å–µ—Å—Å–∏–∏: '; font-weight:bold; }
    #clearBtn { padding:8px 16px; font-size:14px; border:none; border-radius:8px; background:#dc3545; color:#fff; cursor:pointer; }
    #clearBtn:hover { background:#c82333; }
    #goal-selector-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #goal-selector-modal .modal-content { background:#fff; padding:20px; border-radius:8px; max-width:400px; max-height:80%; overflow:auto; }
    #undo-banner { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#e0e0e0; padding:8px 16px; border-radius:20px; font-size:14px; display:none; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; }
    .history-session h3 { margin:12px 0 4px; }
    .history-table { width:100%; border-collapse:collapse; margin-bottom:16px; font-size:14px; }
    .history-table th, .history-table td { border:1px solid #ccc; padding:4px 6px; }
    .history-table th { background:#f0f0f0; }
    .protocol-container > button { margin-bottom:12px; padding:8px 12px; font-size:14px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer; }
    .protocol-container > button:hover { background:#0056b3; }
    .nav-left-floating { position:fixed; bottom:20px; left:20px; }
    .nav-left-floating a { background:#007bff; color:white; padding:14px 18px; border-radius:30px; text-decoration:none; }
  </style>
</head>
<body>
  <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π ABA –ß–µ–∫-–ª–∏—Å—Ç</h2>
  <div class="controls">
    <div>
      <label for="modeSlider">–†–µ–∂–∏–º:</label>
      <input id="modeSlider" type="range" min="0" max="1" step="1" value="1"/>
      <span id="modeText">–ó–∞–ø–∏—Å—å –æ—Ç–≤–µ—Ç–æ–≤</span>
    </div>
    <button id="clearBtn">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–µ–π -->
  <div id="goal-selector-modal">
    <div class="modal-content">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–∏ (–¥–æ 3)</h3>
      <div id="goal-options"></div>
      <button onclick="saveSelectedGoals()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeGoalSelector()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="dailyContainer"></div>
  <div id="undo-banner">–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</div>
  <div id="historyContainer"><h2>–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</h2></div>

  <div class="nav-left-floating">
    <a href="summary_fixed_igram.html">‚¨Ö –°–≤–æ–¥–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç</a>
  </div>

  <script>
    const modeSlider     = document.getElementById('modeSlider');
    const modeText       = document.getElementById('modeText');
    const dailyContainer = document.getElementById('dailyContainer');
    const historyContainer = document.getElementById('historyContainer');
    const undoBanner     = document.getElementById('undo-banner');
    let undoStack = [];

    function toggleMode() {
      const edit = modeSlider.value === '0';
      document.body.classList.toggle('editing', edit);
      modeText.textContent = edit ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : '–ó–∞–ø–∏—Å—å –æ—Ç–≤–µ—Ç–æ–≤';
    }

    function getProtocolsCount() {
      return Object.keys(localStorage)
        .map(k => (k.match(/^protocol(\d+)_title$/) || [])[1])
        .filter(n => n).map(Number)
        .reduce((max,n)=>Math.max(max,n),0);
    }

    function openGoalSelector(idx) {
      window.currentProtocol = idx;
      const opts = document.getElementById('goal-options');
      opts.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem(`protocol${idx}_selectedGoals`)||'[]');
      for(let j=1;j<=10;j++){
        const text = localStorage.getItem(`protocol${idx}_goal${j}`)||`–¶–µ–ª—å ${j}`;
        const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`g${j}`; cb.value=j;
        if(saved.includes(j)) cb.checked=true;
        cb.onchange = ()=>{ if(opts.querySelectorAll('input:checked').length>3) cb.checked=false; };
        const lb = document.createElement('label'); lb.htmlFor=cb.id; lb.textContent=text;
        const dv = document.createElement('div'); dv.append(cb,lb);
        opts.appendChild(dv);
      }
      document.getElementById('goal-selector-modal').style.display='flex';
    }
    function closeGoalSelector(){
      document.getElementById('goal-selector-modal').style.display='none';
    }
    function saveSelectedGoals(){
      const idx = window.currentProtocol;
      const sel = [...document.querySelectorAll('#goal-options input:checked')].map(cb=>+cb.value);
      localStorage.setItem(`protocol${idx}_selectedGoals`, JSON.stringify(sel));
      closeGoalSelector();
      renderDaily();
      renderHistory();
    }

    function sendSessionToGoogle({protocol,results,date,child}) {
      fetch('https://script.google.com/macros/s/AKfycbzu1szsSlgORc4uFgbhy5LvFdCF99UiVuEbzCe_K7UqLvZlmVanUbp6r4pukXbvXZs/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ protocol, results, date, child })
      }).catch(console.error);
    }

    function clearData() {
      const date = localStorage.getItem('session_date') || new Date().toISOString().split('T')[0];
      const child = localStorage.getItem('child_name') || '';
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É
      document.querySelectorAll('.protocol-container').forEach(pc=>{
        const protocol = pc.querySelector('h3').textContent;
        const res = Array.from(pc.querySelectorAll('.percent'))
          .map(el=>{ const t=el.textContent.trim(); return t==='‚Äî'?null:parseInt(t); });
        sendSessionToGoogle({protocol,results:res,date,child});
      });
      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
      const session = { date, data: [] };
      document.querySelectorAll('.protocol-container').forEach(pc=>{
        const arr = [...pc.querySelectorAll('.percent')].map(e=>{
          const t=e.textContent.trim(); return t==='‚Äî'?null:parseInt(t);
        });
        session.data.push(arr);
      });
      const hist = JSON.parse(localStorage.getItem('aba_history')||'[]');
      hist.push(session); if(hist.length>10) hist.shift();
      localStorage.setItem('aba_history',JSON.stringify(hist));
      // —á–∏—Å—Ç–∏–º UI
      document.querySelectorAll('.count').forEach(e=>e.textContent='0');
      updatePercentages(); saveProgress(); renderHistory();
    }

    function renderDaily() {
      const hist = JSON.parse(localStorage.getItem('aba_history')||'[]');
      const last3 = hist.slice(-3);
      dailyContainer.innerHTML = '';
      const cnt = getProtocolsCount();
      for(let i=1;i<=cnt;i++){
        const wrapper = document.createElement('div');
        wrapper.className='protocol-container';
        wrapper.dataset.index=i;
        const title = localStorage.getItem(`protocol${i}_title`)||`–ü—Ä–æ—Ç–æ–∫–æ–ª ${i}`;
        const sel   = JSON.parse(localStorage.getItem(`protocol${i}_selectedGoals`)||'[]');
        const toShow= sel.length?sel:[1,2,3];
        wrapper.innerHTML = `<h3>${title}</h3>
          <button onclick="openGoalSelector(${i})">–í—ã–±—Ä–∞—Ç—å —Ü–µ–ª–∏</button>`;
        toShow.forEach((j,rowPos)=>{
          const txt = localStorage.getItem(`protocol${i}_goal${j}`)||`–¶–µ–ª—å ${j}`;
          const prevArr = last3.map(sess=>{ const v=sess.data[i-1]?.[rowPos]; return v==null?'‚Äî':v+'%'; });
          const block = document.createElement('div'); block.className='block';
          block.innerHTML = `
            <div class="goal-label">${txt}</div>
            <div class="btn-set">
              <div><button class="btn-success" onclick="increment(this)">‚úÖ</button><div class="count">0</div></div>
              <div><button class="btn-prompt"  onclick="increment(this)">ü§ù</button><div class="count">0</div></div>
              <div><button class="btn-error"   onclick="increment(this)">‚ûñ</button><div class="count">0</div></div>
            </div>
            <div class="percent">‚Äî</div>
            <div class="prev-percent">${prevArr.join(' | ')}</div>
          `;
          wrapper.appendChild(block);
        });
        dailyContainer.appendChild(wrapper);
      }
    }

    function renderHistory() {
      const hist = JSON.parse(localStorage.getItem('aba_history')||'[]');
      const cnt  = getProtocolsCount();
      historyContainer.innerHTML = '<h2>–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</h2>';
      if(!hist.length){ historyContainer.innerHTML+='<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.</p>'; return; }
      for(let i=1;i<=cnt;i++){
        const title = localStorage.getItem(`protocol${i}_title`)||`–ü—Ä–æ—Ç–æ–∫–æ–ª ${i}`;
        const sel   = JSON.parse(localStorage.getItem(`protocol${i}_selectedGoals`)||'[]')||[1,2,3];
        const sec = document.createElement('div'); sec.className='history-session';
        const hdr = document.createElement('h3'); hdr.textContent=title; sec.appendChild(hdr);
        const tbl = document.createElement('table'); tbl.className='history-table';
        const thead = tbl.createTHead();
        const hr = thead.insertRow();
        hr.insertCell().textContent='–¶–µ–ª—å';
        hist.forEach(sess=>hr.insertCell().textContent=sess.date);
        const tbody = tbl.createTBody();
        sel.forEach((gIdx,k)=>{
          const tr = tbody.insertRow();
          tr.insertCell().textContent = localStorage.getItem(`protocol${i}_goal${gIdx}`)||`–¶–µ–ª—å ${gIdx}`;
          hist.forEach(sess=> {
            const v = sess.data[i-1]?.[k];
            tr.insertCell().textContent = v==null?'‚Äî':v+'%';
          });
        });
        sec.appendChild(tbl);
        historyContainer.appendChild(sec);
      }
    }

    function increment(btn) {
      if(btn.disabled) return;
      const cntEl = btn.nextElementSibling;
      cntEl.textContent = +cntEl.textContent + 1;
      updatePercentages();
      saveProgress();
      undoStack.push(btn);
      showUndo();
    }

    function showUndo(){
      undoBanner.style.display='block';
      clearTimeout(window.undoTimeout);
      window.undoTimeout=setTimeout(()=>{ if(!undoStack.length) undoBanner.style.display='none'; },5000);
    }
    undoBanner.onclick = ()=>{
      if(undoStack.length){
        const b=undoStack.pop(), c=b.nextElementSibling;
        c.textContent=Math.max(+c.textContent-1,0);
        updatePercentages(); saveProgress();
      }
      if(!undoStack.length) undoBanner.style.display='none';
    };

    function updatePercentages(){
      document.querySelectorAll('.block').forEach(block=>{
        const counts=[...block.querySelectorAll('.count')].map(d=>+d.textContent);
        const total=counts.reduce((s,v)=>s+v,0), el=block.querySelector('.percent');
        if(total===0){
          el.textContent='‚Äî'; el.className='percent';
        } else {
          const pct=Math.round(counts[0]/total*100);
          el.textContent=pct+'%';
          el.className='percent '+(pct>=80?'green':pct>=50?'orange':'red');
        }
      });
    }

    function saveProgress(){
      const arr=[...document.querySelectorAll('.count')].map(d=>d.textContent);
      localStorage.setItem('aba_counts',JSON.stringify(arr));
    }

    function loadProgress(){
      const arr=JSON.parse(localStorage.getItem('aba_counts')||'[]');
      document.querySelectorAll('.count').forEach((d,i)=>{ if(arr[i]!=null) d.textContent=arr[i]; });
      updatePercentages();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      modeSlider.oninput=toggleMode;
      document.getElementById('clearBtn').onclick=clearData;
      renderDaily(); loadProgress(); renderHistory(); toggleMode();
    });
  </script>
</body>
</html>
